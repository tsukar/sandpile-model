<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <style>
      #field { height: 800px; }
    </style>
  </head>
  <body>
  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column">
          First column
        </div>
        <div class="column">
          <div id="field"></div>
        </div>
      </div>
    </div>
  </section>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/106/three.min.js"></script>
  <script>
    var grid;
    var gridSize = 10;
    var histogram = {};
    var frameCount = 0;
    var magnitude = 0;

    function initGrid() {
      grid = new Array(gridSize);
      for (var i = 0; i < gridSize; i++) {
        grid[i] = new Array(gridSize);
        for (var j = 0; j < gridSize; j++) {
          grid[i][j] = 0;
        }
      }
    }

    function updateGrid() {
      oldGrid = grid;
      var updateFlag = false;

      for (var i = 0; i < gridSize; i++) {
        for (var j = 0; j < gridSize; j++) {
          if (oldGrid[i][j] >= 4) {
            updateFlag = true;

            grid[i][j] -= 4;
            if (i > 0) { grid[i - 1][j]++; }
            if (j > 0) { grid[i][j - 1]++; }
            if (i < gridSize - 1) { grid[i + 1][j]++; }
            if (j < gridSize - 1) { grid[i][j + 1]++; }
          }
        }
      }

      return updateFlag;
    }

    function addSand() {
      grid[gridSize / 2][gridSize / 2]++;
    }

    function countFrequency(key) {
      if (key in histogram) {
        histogram[key]++;
      } else {
        histogram[key] = 1;
      }
    }

    var field = document.getElementById( "field" );
    var fieldWidth = field.clientWidth;
    var fieldHeight = field.clientHeight;
    var scene;

    var camera = new THREE.PerspectiveCamera( 75, fieldWidth / fieldHeight, 0.1, 1000 );

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize( fieldWidth, fieldHeight );
    field.appendChild( renderer.domElement );

    var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );

    function buildScene() {
      scene = new THREE.Scene();
      for (var i = 0; i < gridSize; i++) {
        for (var j = 0; j < gridSize; j++) {
          var geometry = new THREE.BoxGeometry( 2, 2, grid[i][j] * 2 );
          var cube = new THREE.Mesh( geometry, material );

          cube.position.x = i * 2 - gridSize;
          cube.position.y = j * 2 - gridSize;
          cube.position.z = grid[i][j];

          scene.add( cube );
        }
      }
    }

    camera.position.z = 100;

    initGrid();
    var animate = function () {
      requestAnimationFrame( animate );

      if (++frameCount % 6 == 0) {
        if (updateGrid()) {
          magnitude += 1;
        } else {
          if (magnitude > 0) {
            countFrequency(magnitude);
            magnitude = 0;
          }
          addSand();
        }
        buildScene();
        renderer.render( scene, camera );
      }
    };

    animate();
  </script>
  </body>
</html>
